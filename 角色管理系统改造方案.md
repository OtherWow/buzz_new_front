# 角色管理系统改造方案

## 项目概述

基于现有的 `buzz_common` 用户系统和 `ccxt_fast_api` 后端项目，实现一个轻量级的角色权限管理系统。该方案采用最小化改动原则，不破坏现有业务逻辑。

## 现状分析

### 现有用户系统
- **用户表**: `BoBaseUsers` - 包含用户基本信息
- **合伙人表**: `UserPartner` - 管理合伙人关系（注意：`user_partner` 字段不代表用户角色）
- **认证机制**: JWT Token 认证
- **数据库**: SQLModel + SQLAlchemy

### 现有问题
- 缺乏统一的权限管理系统
- 无法动态控制菜单和按钮显示
- 前端无法进行角色和权限配置

## 改造方案

### 1. 数据库设计（最小化改动）

#### 1.1 新增数据表

**角色表 (bo_base_roles)**
```python
class BoBaseRoles(SQLModel, table=True):
    __tablename__ = "bo_base_roles"
    
    id: int = Field(default=None, primary_key=True, description="角色ID")
    role_name: str = Field(max_length=100, unique=True, description="角色名称")
    role_code: str = Field(max_length=50, unique=True, description="角色代码")
    description: Optional[str] = Field(max_length=255, description="角色描述")
    is_active: int = Field(default=1, description="是否激活 0.禁用 1.启用")
    is_system: int = Field(default=0, description="是否系统角色 0.否 1.是")
    create_time: datetime = Field(default_factory=datetime.now, description="创建时间")
    update_time: datetime = Field(default_factory=datetime.now, description="更新时间")
```

**权限表 (bo_base_permissions)**
```python
class BoBasePermissions(SQLModel, table=True):
    __tablename__ = "bo_base_permissions"
    
    id: int = Field(default=None, primary_key=True, description="权限ID")
    permission_name: str = Field(max_length=100, description="权限名称")
    permission_code: str = Field(max_length=100, unique=True, description="权限代码")
    resource_type: str = Field(max_length=50, description="资源类型 menu/button/api")
    parent_id: Optional[int] = Field(default=0, description="父级权限ID")
    sort_order: Optional[int] = Field(default=0, description="排序")
    description: Optional[str] = Field(max_length=255, description="权限描述")
    is_active: int = Field(default=1, description="是否激活")
    create_time: datetime = Field(default_factory=datetime.now, description="创建时间")
    update_time: datetime = Field(default_factory=datetime.now, description="更新时间")
```

**角色权限关联表 (bo_role_permissions)**
```python
class BoRolePermissions(SQLModel, table=True):
    __tablename__ = "bo_role_permissions"
    
    id: int = Field(default=None, primary_key=True, description="主键ID")
    role_id: int = Field(description="角色ID")
    permission_id: int = Field(description="权限ID")
    create_time: datetime = Field(default_factory=datetime.now, description="创建时间")
```

#### 1.2 修改现有用户表

**在 BoBaseUsers 表中添加角色字段**
```python
# 在 BoBaseUsers 类中新增字段
role_id: Optional[int] = Field(default=1, description="用户角色ID，默认为普通用户")
```

### 2. 预设角色和权限

#### 2.1 默认角色
1. **系统管理员** (admin) - 拥有所有页面和功能权限
2. **SVIP用户** (svip) - 目前与VIP和普通用户权限相同，预留扩展
3. **VIP用户** (vip) - 目前与普通用户权限相同，预留扩展  
4. **普通用户** (user) - 基础功能权限

#### 2.2 页面权限分配

**系统管理员可访问所有页面：**
- 系统首页
- 用户管理页面
- 角色管理页面  
- 权限管理页面
- 交易所管理（交易查询、余额查询、资金动态、盈亏分析）
- 马丁策略管理（马丁策略列表、马丁监控器）
- 免责声明

**普通用户/VIP/SVIP可访问页面：**
- 系统首页
- 交易所管理（交易查询、余额查询、资金动态、盈亏分析）
- 马丁策略管理（马丁策略列表、马丁监控器）
- 免责声明

#### 2.3 权限代码设计
采用 `资源:操作` 格式：

**基础权限：**
- `dashboard:read` - 系统首页
- `disclaimer:read` - 免责声明

**交易所管理权限：**
- `exchange:read` - 交易所管理总权限
- `exchange:trade_query` - 交易查询
- `exchange:balance_query` - 余额查询  
- `exchange:fund_flow` - 资金动态
- `exchange:profit_analysis` - 盈亏分析

**马丁策略管理权限：**
- `martin:read` - 马丁策略管理总权限
- `martin:strategy_list` - 马丁策略列表
- `martin:monitor` - 马丁监控器

**系统管理权限（仅系统管理员）：**
- `user:read` - 用户查看
- `user:create` - 用户创建  
- `user:update` - 用户编辑
- `user:delete` - 用户删除
- `role:read` - 角色查看
- `role:create` - 角色创建
- `role:update` - 角色编辑
- `role:delete` - 角色删除
- `permission:read` - 权限查看
- `permission:create` - 权限创建
- `permission:update` - 权限编辑
- `permission:delete` - 权限删除

### 3. 后端实现

#### 3.1 新增模型文件
**位置**: `buzz_common/a01_db/user_models/role_models.py`

#### 3.2 权限检查装饰器
```python
# 位置: ccxt_fast_api/api/auth/permission_decorator.py
def require_permission(permission_code: str):
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # 从请求中获取用户信息
            user = kwargs.get('current_user') or args[0] # 根据实际情况调整
            if not user:
                raise HTTPException(status_code=401, detail="未登录")
            
            # 检查权限
            if not await check_user_permission(user.id, permission_code):
                raise HTTPException(status_code=403, detail="权限不足")
            
            return await func(*args, **kwargs)
        return wrapper
    return decorator
```

#### 3.3 权限服务
**位置**: `ccxt_fast_api/api/auth/permission_service.py`
- 用户权限查询
- 角色权限管理
- 权限验证逻辑

#### 3.4 新增API路由
**角色管理 API**: `ccxt_fast_api/api/roles/routers.py`
- GET `/api/roles` - 角色列表
- POST `/api/roles` - 创建角色
- PUT `/api/roles/{id}` - 更新角色
- DELETE `/api/roles/{id}` - 删除角色

**权限管理 API**: `ccxt_fast_api/api/permissions/routers.py`
- GET `/api/permissions` - 权限列表
- POST `/api/permissions` - 创建权限
- GET `/api/permissions/tree` - 权限树结构

#### 3.5 修改现有认证逻辑
**位置**: `ccxt_fast_api/api/auth/auth.py`
- 登录时获取用户角色和权限信息
- Token 中包含权限信息或Redis缓存权限

### 4. 前端适配

#### 4.1 权限状态管理
前端 `buzz_new_front` 项目已具备完整的权限系统，只需要对接后端API：
- 用户登录获取角色权限信息
- 权限指令 `v-permission` 控制按钮显示
- 路由守卫控制页面访问

#### 4.2 新增管理页面
- 角色管理页面 - 角色的增删改查
- 权限管理页面 - 权限配置
- 用户角色分配页面

### 5. 实施步骤

#### 阶段一：数据库改造
1. 创建新的数据表
2. 在用户表中添加role_id字段
3. 初始化默认角色和权限数据

#### 阶段二：后端权限系统
1. 创建角色权限模型
2. 实现权限服务和装饰器
3. 添加角色权限管理API
4. 修改登录逻辑，返回权限信息

#### 阶段三：前端集成
1. 对接权限API
2. 实现角色权限管理界面
3. 测试权限控制功能

### 6. 数据迁移

#### 6.1 现有用户角色分配
```sql
-- 将现有用户默认分配为普通用户角色
UPDATE bo_base_users SET role_id = 4 WHERE role_id IS NULL;

-- 可根据现有业务逻辑设置不同角色
-- 将管理员用户设为系统管理员角色
UPDATE bo_base_users SET role_id = 1 WHERE username IN ('admin', 'root');

-- 如果有VIP用户标识，可以批量设置
-- UPDATE bo_base_users SET role_id = 3 WHERE user_level = 'vip';
-- UPDATE bo_base_users SET role_id = 2 WHERE user_level = 'svip';
```

### 7. 兼容性保证

- **不破坏现有业务**: 新增字段均设置默认值
- **渐进式升级**: 可选择性地在不同模块中启用权限检查
- **向下兼容**: 未设置权限的接口继续正常工作

### 8. 配置示例

#### 8.1 角色权限配置示例
```json
{
  "roles": {
    "admin": {
      "id": 1,
      "name": "系统管理员",
      "permissions": [
        "dashboard:read", "disclaimer:read",
        "exchange:read", "exchange:trade_query", "exchange:balance_query", 
        "exchange:fund_flow", "exchange:profit_analysis",
        "martin:read", "martin:strategy_list", "martin:monitor",
        "user:read", "user:create", "user:update", "user:delete",
        "role:read", "role:create", "role:update", "role:delete",
        "permission:read", "permission:create", "permission:update", "permission:delete"
      ]
    },
    "svip": {
      "id": 2,
      "name": "SVIP用户",
      "permissions": [
        "dashboard:read", "disclaimer:read",
        "exchange:read", "exchange:trade_query", "exchange:balance_query",
        "exchange:fund_flow", "exchange:profit_analysis", 
        "martin:read", "martin:strategy_list", "martin:monitor"
      ]
    },
    "vip": {
      "id": 3,
      "name": "VIP用户",
      "permissions": [
        "dashboard:read", "disclaimer:read",
        "exchange:read", "exchange:trade_query", "exchange:balance_query",
        "exchange:fund_flow", "exchange:profit_analysis",
        "martin:read", "martin:strategy_list", "martin:monitor"
      ]
    },
    "user": {
      "id": 4,
      "name": "普通用户", 
      "permissions": [
        "dashboard:read", "disclaimer:read",
        "exchange:read", "exchange:trade_query", "exchange:balance_query",
        "exchange:fund_flow", "exchange:profit_analysis",
        "martin:read", "martin:strategy_list", "martin:monitor"
      ]
    }
  }
}
```

#### 8.2 前端路由权限配置
```javascript
// 前端路由配置示例
const routes = [
  {
    path: '/dashboard',
    component: Dashboard,
    meta: { 
      title: '系统首页',
      permission: 'dashboard:read'
    }
  },
  {
    path: '/users',
    component: UserManagement,
    meta: { 
      title: '用户管理',
      permission: 'user:read'
    }
  },
  {
    path: '/exchange',
    component: ExchangeManagement,
    meta: { 
      title: '交易所管理',
      permission: 'exchange:read'
    },
    children: [
      {
        path: 'trade-query',
        component: TradeQuery,
        meta: { permission: 'exchange:trade_query' }
      },
      {
        path: 'balance-query', 
        component: BalanceQuery,
        meta: { permission: 'exchange:balance_query' }
      }
    ]
  }
]
```

## 优势

1. **最小化改动**: 只新增必要的表和字段，不修改现有业务逻辑
2. **灵活性高**: 支持动态权限配置，易于扩展
3. **前后端分离**: 前端已有完整权限框架，后端只需提供数据
4. **渐进式实施**: 可按模块逐步启用权限控制
5. **维护成本低**: 设计简洁，便于理解和维护

## 风险评估

- **数据库变更风险**: 低（只新增表和字段）
- **业务影响风险**: 极低（不改变现有API行为）
- **性能影响**: 微乎其微（权限查询可缓存）

## 后续优化

- 权限缓存优化
- 菜单权限动态配置
- 数据权限控制（行级权限）
- 权限审计日志

此方案确保了系统的稳定性和可扩展性，同时最大程度地减少了对现有系统的影响。